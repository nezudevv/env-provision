#!/usr/bin/env bash

set -e  # Exit on error

log() {
	echo "➜ $@"
}

error() {
	echo "✗ $@" >&2
	exit 1
}

success() {
	echo "✓ $@"
}

log "--------- Installing Dependencies ---------"

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
	error "Homebrew not found. Install it first:
	/bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
fi

success "Homebrew installed"

# Install Homebrew packages
log "Installing Homebrew packages..."
brew_packages=(
	tmux
	fzf
	zoxide
	gnu-sed  # gsed
	neovim
	git
	zed
	zsh-syntax-highlighting
	node  # Includes npm
	nvm
	rust
)

for package in "${brew_packages[@]}"; do
	if brew list "$package" &>/dev/null; then
		log "$package already installed"
	else
		log "Installing $package..."
		brew install "$package"
	fi
done

success "Homebrew packages installed"

# Upgrade already-installed packages (including rust)
log "Upgrading already-installed packages..."
brew upgrade 2>/dev/null || log "All packages up to date"
success "Packages upgraded"

# Install Powerlevel10k via Homebrew
log "Installing Powerlevel10k..."
if brew list powerlevel10k &>/dev/null; then
	log "Powerlevel10k already installed"
else
	brew install romkatv/powerlevel10k/powerlevel10k
	success "Powerlevel10k installed"
fi

# Install Oh My Zsh
log "Installing Oh My Zsh..."
if [ -d "$HOME/.oh-my-zsh" ]; then
	log "Oh My Zsh already installed"
else
	sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
	success "Oh My Zsh installed"
fi

# Install fzf shell integration
log "Installing fzf shell integration..."
if [ -f "$HOME/.fzf.zsh" ]; then
	log "fzf already configured"
else
	"$(brew --prefix)"/opt/fzf/install --key-bindings --completion --no-update-rc --no-bash --no-fish
	success "fzf configured"
fi

# Install tmux plugin manager (TPM)
log "Installing tmux plugin manager..."
if [ -d "$HOME/.tmux/plugins/tpm" ]; then
	log "TPM already installed"
else
	git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
	success "TPM installed"
fi

# Install tmux plugins automatically
log "Installing tmux plugins..."
if [ -f "$HOME/.tmux/plugins/tpm/bin/install_plugins" ]; then
	"$HOME/.tmux/plugins/tpm/bin/install_plugins"
	success "Tmux plugins installed"
else
	log "TPM not found, skipping plugin installation"
fi

# Install global npm packages
log "Installing global npm packages..."
npm_packages=(
	"@vue/language-server"  # Required for Vue3 TypeScript support in Neovim
)

for package in "${npm_packages[@]}"; do
	if npm list -g "$package" &>/dev/null; then
		log "$package already installed"
	else
		log "Installing $package..."
		npm install -g "$package"
		success "$package installed"
	fi
done

success "Global npm packages installed"

# Install Nerd Fonts
log "Installing Nerd Fonts..."
brew tap homebrew/cask-fonts 2>/dev/null || true

fonts=(
	font-jetbrains-mono-nerd-font
	font-commit-mono-nerd-font
)

for font in "${fonts[@]}"; do
	if brew list --cask "$font" &>/dev/null; then
		log "$font already installed"
	else
		log "Installing $font..."
		# Use || true to continue if font files already exist (installed manually)
		brew install --cask "$font" 2>/dev/null || log "$font already exists on system"
	fi
done

success "Nerd Fonts checked"

# Check Powerlevel10k configuration
log "Checking Powerlevel10k configuration..."
if [ -f "$HOME/.p10k.zsh" ]; then
	success "Powerlevel10k configuration found"
else
	log "⚠️  Powerlevel10k configuration not found"
	log "    You'll need to run: p10k configure"
fi

log ""
log "✓ All dependencies installed!"
log ""
log "Next steps:"
log "  1. Run: ./run"
log "  2. Restart your terminal"
if [ ! -f "$HOME/.p10k.zsh" ]; then
	log "  3. Configure Powerlevel10k: p10k configure"
fi
